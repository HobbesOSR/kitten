diff -r openmpi-1.2.9/configure openmpi-patch/configure
77050c77050
< return cnos_barrier ();
---
> //return cnos_barrier ();
77144c77144
< return $ac_func ();
---
> //return $ac_func ();
93934c93934
< return $ac_func ();
---
> //return $ac_func ();
98182c98182
< return cnos_get_rank ();
---
> //return cnos_get_rank ();
diff -r openmpi-1.2.9/contrib/platform/redstorm openmpi-patch/contrib/platform/redstorm
4d3
< with_threads=no
9c8
< enable_mca_no_build=maffinity-first_use,maffinity-libnuma,paffinity-linux,timer-linux,gpr-proxy,gpr-replica,iof-svc,ns-proxy,oob-tcp,pls-rsh,ras-dash_host,ras-hostfile,ras-localhost,rds-hostfile,rds-resfile,rmaps-round_robin,rmgr-proxy,rmgr-urm,rml-oob,sds-env,sds-seed,sds-singleton,btl-sm,btl-self,coll-hierarch,coll-sm,common-sm,mpool-sm,pml-dr
---
> enable_mca_no_build=maffinity-first_use,maffinity-libnuma,paffinity-linux,timer-linux,gpr-proxy,gpr-replica,iof-svc,ns-proxy,oob-tcp,pls-rsh,ras-dash_host,ras-hostfile,ras-localhost,rds-hostfile,rds-resfile,rmaps-round_robin,rmgr-proxy,rmgr-urm,rml-oob,sds-env,sds-seed,sds-singleton,btl-sm,coll-hierarch,coll-sm,common-sm,mpool-sm,pml-dr
16,98d14
< ac_cv_func_poll=no
< ac_cv_func_select=no
< ac_cv_header_poll_h=no
< ac_cv_header_sys_epoll_h=no
< ac_cv_func_getpwuid=no
< ac_cv_header_infiniband_driver_h=yes
< 
< ompi_cv_f77_sizeof_LOGICAL=${ompi_cv_f77_sizeof_LOGICAL=4}
< ompi_cv_f77_alignment_LOGICAL=${ompi_cv_f77_alignment_LOGICAL=4}
< ompi_cv_f77_sizeof_INTEGER=${ompi_cv_f77_sizeof_INTEGER=4}
< ompi_cv_f77_alignment_INTEGER=${ompi_cv_f77_alignment_INTEGER=4}
< ompi_cv_f77_sizeof_INTEGERp1=${ompi_cv_f77_sizeof_INTEGERp1=1}
< ompi_cv_f77_alignment_INTEGERp1=${ompi_cv_f77_alignment_INTEGERp1=1}
< ompi_cv_f77_sizeof_INTEGERp2=${ompi_cv_f77_sizeof_INTEGERp2=2}
< ompi_cv_f77_alignment_INTEGERp2=${ompi_cv_f77_alignment_INTEGERp2=2}
< ompi_cv_f77_sizeof_INTEGERp4=${ompi_cv_f77_sizeof_INTEGERp4=4}
< ompi_cv_f77_alignment_INTEGERp4=${ompi_cv_f77_alignment_INTEGERp4=4}
< ompi_cv_f77_sizeof_INTEGERp8=${ompi_cv_f77_sizeof_INTEGERp8=8}
< ompi_cv_f77_alignment_INTEGERp8=${ompi_cv_f77_alignment_INTEGERp8=8}
< ompi_cv_f77_sizeof_INTEGERp16=${ompi_cv_f77_sizeof_INTEGERp16=16}
< ompi_cv_f77_alignment_INTEGERp16=${ompi_cv_f77_alignment_INTEGERp16=8}
< ompi_cv_f77_sizeof_REAL=${ompi_cv_f77_sizeof_REAL=4}
< ompi_cv_f77_alignment_REAL=${ompi_cv_f77_alignment_REAL=4}
< ompi_cv_f77_sizeof_REALp2=${ompi_cv_f77_sizeof_REALp2=2}
< ompi_cv_f77_alignment_REALp2=${ompi_cv_f77_alignment_REALp2=2}
< ompi_cv_f77_sizeof_REALp4=${ompi_cv_f77_sizeof_REALp4=4}
< ompi_cv_f77_alignment_REALp4=${ompi_cv_f77_alignment_REALp4=4}
< ompi_cv_f77_sizeof_REALp8=${ompi_cv_f77_sizeof_REALp8=8}
< ompi_cv_f77_alignment_REALp8=${ompi_cv_f77_alignment_REALp8=8}
< ompi_cv_f77_sizeof_REALp16=${ompi_cv_f77_sizeof_REALp16=16}
< ompi_cv_f77_alignment_REALp16=${ompi_cv_f77_alignment_REALp16=8}
< ompi_cv_f77_sizeof_DOUBLE_PRECISION=${ompi_cv_f77_sizeof_DOUBLE_PRECISION=8}
< ompi_cv_f77_alignment_DOUBLE_PRECISION=${ompi_cv_f77_alignment_DOUBLE_PRECISION=8}
< ompi_cv_f77_sizeof_COMPLEX=${ompi_cv_f77_sizeof_COMPLEX=8}
< ompi_cv_f77_alignment_COMPLEX=${ompi_cv_f77_alignment_COMPLEX=4}
< ompi_cv_f77_sizeof_COMPLEXp8=${ompi_cv_f77_sizeof_COMPLEXp8=8}
< ompi_cv_f77_alignment_COMPLEXp8=${ompi_cv_f77_alignment_COMPLEXp8=4}
< ompi_cv_f77_sizeof_COMPLEXp16=${ompi_cv_f77_sizeof_COMPLEXp16=16}
< ompi_cv_f77_alignment_COMPLEXp16=${ompi_cv_f77_alignment_COMPLEXp16=8}
< ompi_cv_f77_sizeof_COMPLEXp32=${ompi_cv_f77_sizeof_COMPLEXp32=32}
< ompi_cv_f77_alignment_COMPLEXp32=${ompi_cv_f77_alignment_COMPLEXp32=8}
< ompi_cv_f77_true_value=${ompi_cv_f77_true_value=-1}
< 
< 
< ompi_cv_f90_sizeof_LOGICAL=${ompi_cv_f90_sizeof_LOGICAL=4}
< ompi_cv_f90_alignment_LOGICAL=${ompi_cv_f90_alignment_LOGICAL=4}
< ompi_cv_f90_sizeof_INTEGER=${ompi_cv_f90_sizeof_INTEGER=4}
< ompi_cv_f90_alignment_INTEGER=${ompi_cv_f90_alignment_INTEGER=4}
< ompi_cv_f90_sizeof_INTEGERp1=${ompi_cv_f90_sizeof_INTEGERp1=1}
< ompi_cv_f90_alignment_INTEGERp1=${ompi_cv_f90_alignment_INTEGERp1=1}
< ompi_cv_f90_sizeof_INTEGERp2=${ompi_cv_f90_sizeof_INTEGERp2=2}
< ompi_cv_f90_alignment_INTEGERp2=${ompi_cv_f90_alignment_INTEGERp2=2}
< ompi_cv_f90_sizeof_INTEGERp4=${ompi_cv_f90_sizeof_INTEGERp4=4}
< ompi_cv_f90_alignment_INTEGERp4=${ompi_cv_f90_alignment_INTEGERp4=4}
< ompi_cv_f90_sizeof_INTEGERp8=${ompi_cv_f90_sizeof_INTEGERp8=8}
< ompi_cv_f90_alignment_INTEGERp8=${ompi_cv_f90_alignment_INTEGERp8=8}
< ompi_cv_f90_sizeof_INTEGERp16=${ompi_cv_f90_sizeof_INTEGERp16=16}
< ompi_cv_f90_alignment_INTEGERp16=${ompi_cv_f90_alignment_INTEGERp16=8}
< ompi_cv_f90_sizeof_REAL=${ompi_cv_f90_sizeof_REAL=4}
< ompi_cv_f90_alignment_REAL=${ompi_cv_f90_alignment_REAL=4}
< ompi_cv_f90_sizeof_REALp2=${ompi_cv_f90_sizeof_REALp2=2}
< ompi_cv_f90_alignment_REALp2=${ompi_cv_f90_alignment_REALp2=2}
< ompi_cv_f90_sizeof_REALp4=${ompi_cv_f90_sizeof_REALp4=4}
< ompi_cv_f90_alignment_REALp4=${ompi_cv_f90_alignment_REALp4=4}
< ompi_cv_f90_sizeof_REALp8=${ompi_cv_f90_sizeof_REALp8=8}
< ompi_cv_f90_alignment_REALp8=${ompi_cv_f90_alignment_REALp8=8}
< ompi_cv_f90_sizeof_REALp16=${ompi_cv_f90_sizeof_REALp16=16}
< ompi_cv_f90_alignment_REALp16=${ompi_cv_f90_alignment_REALp16=8}
< ompi_cv_f90_sizeof_DOUBLE_PRECISION=${ompi_cv_f90_sizeof_DOUBLE_PRECISION=8}
< ompi_cv_f90_alignment_DOUBLE_PRECISION=${ompi_cv_f90_alignment_DOUBLE_PRECISION=8}
< ompi_cv_f90_sizeof_COMPLEX=${ompi_cv_f90_sizeof_COMPLEX=8}
< ompi_cv_f90_alignment_COMPLEX=${ompi_cv_f90_alignment_COMPLEX=4}
< ompi_cv_f90_sizeof_COMPLEXp8=${ompi_cv_f90_sizeof_COMPLEXp8=8}
< ompi_cv_f90_alignment_COMPLEXp8=${ompi_cv_f90_alignment_COMPLEXp8=4}
< ompi_cv_f90_sizeof_COMPLEXp16=${ompi_cv_f90_sizeof_COMPLEXp16=16}
< ompi_cv_f90_alignment_COMPLEXp16=${ompi_cv_f90_alignment_COMPLEXp16=8}
< ompi_cv_f90_sizeof_COMPLEXp32=${ompi_cv_f90_sizeof_COMPLEXp32=32}
< ompi_cv_f90_alignment_COMPLEXp32=${ompi_cv_f90_alignment_COMPLEXp32=8}
< ompi_cv_f90_true_value=${ompi_cv_f90_true_value=-1}
< ompi_cv_f90_sizeof_DOUBLE_COMPLEX=${ompi_cv_f90_sizeof_DOUBLE_COMPLEX=16}
< ompi_cv_f90_alignment_DOUBLE_COMPLEX=${ompi_cv_f90_alignment_DOUBLE_COMPLEX=8}
< ompi_cv_f90_int_kind_9=${ompi_cv_f90_int_kind_9=4}
< ompi_cv_f90_int_kind_18=${ompi_cv_f90_int_kind_18=8}
diff -r openmpi-1.2.9/ompi/mca/btl/openib/btl_openib_component.c openmpi-patch/ompi/mca/btl/openib/btl_openib_component.c
932,936c932,936
< #if OMPI_MCA_BTL_OPENIB_HAVE_DEVICE_LIST
<     ibv_free_device_list(ib_devs);
< #else
<     free(ib_devs);
< #endif
---
> //#if OMPI_MCA_BTL_OPENIB_HAVE_DEVICE_LIST
> //    ibv_free_device_list(ib_devs);
> //#else
> //    free(ib_devs);
> //#endif
diff -r openmpi-1.2.9/ompi/mca/btl/openib/btl_openib_proc.c openmpi-patch/ompi/mca/btl/openib/btl_openib_proc.c
130a131
> #if 0
145a147,152
> #endif
> 
> // this is a memory leak
> 	size =  sizeof( struct mca_btl_openib_port_info_t );
> 	module_proc->proc_ports = malloc( size );
> 	module_proc->proc_ports[0].subnet_id = 0xfe80000000000000;
diff -r openmpi-1.2.9/ompi/runtime/ompi_mpi_init.c openmpi-patch/ompi/runtime/ompi_mpi_init.c
599a600
>         opal_set_using_threads(true);
diff -r openmpi-1.2.9/opal/include/opal_config_bottom.h openmpi-patch/opal/include/opal_config_bottom.h
58c58,59
< #define OMPI_HAVE_THREAD_SUPPORT (OMPI_ENABLE_MPI_THREADS || OMPI_ENABLE_PROGRESS_THREADS)
---
> //#define OMPI_HAVE_THREAD_SUPPORT (OMPI_ENABLE_MPI_THREADS || OMPI_ENABLE_PROGRESS_THREADS)
> #define OMPI_HAVE_THREAD_SUPPORT 1
diff -r openmpi-1.2.9/opal/util/if.c openmpi-patch/opal/util/if.c
133a134
>     OBJ_CONSTRUCT(&opal_if_list, opal_list_t);
210c211
<     OBJ_CONSTRUCT(&opal_if_list, opal_list_t);
---
>     //OBJ_CONSTRUCT(&opal_if_list, opal_list_t);
diff -r openmpi-1.2.9/orte/mca/pls/cnos/pls_cnos.c openmpi-patch/orte/mca/pls/cnos/pls_cnos.c
34c34
< #include <catamount/cnos_mpi_os.h>
---
> //#include <catamount/cnos_mpi_os.h>
42a43,45
> #undef printf
> #define printf(arg,...)
> 
67a71
> printf("%s %d\n",__FUNCTION__,__LINE__);
72c76
< #include "catamount/types.h"
---
> //#include "catamount/types.h"
74c78
< extern int killrank(rank_t RANK, int SIG);
---
> //extern int killrank(rank_t RANK, int SIG);
80a85,87
> printf("%s %d\n",__FUNCTION__,__LINE__);
> 
> #if 0
88a96
> #endif
97a106,108
> printf("%s %d\n",__FUNCTION__,__LINE__);
> 
> #if 0
105a117
> #endif
115a128
> printf("%s %d\n",__FUNCTION__,__LINE__);
117a131
> #if 0
124a139
> #endif
131a147
> printf("%s %d\n",__FUNCTION__,__LINE__);
136a153
> printf("%s %d\n",__FUNCTION__,__LINE__);
141a159
> printf("%s %d\n",__FUNCTION__,__LINE__);
146a165
> printf("%s %d\n",__FUNCTION__,__LINE__);
diff -r openmpi-1.2.9/orte/mca/pls/cnos/pls_cnos_component.c openmpi-patch/orte/mca/pls/cnos/pls_cnos_component.c
20c20
< #include <catamount/cnos_mpi_os.h>
---
> //#include <catamount/cnos_mpi_os.h>
diff -r openmpi-1.2.9/orte/mca/rmgr/cnos/rmgr_cnos.c openmpi-patch/orte/mca/rmgr/cnos/rmgr_cnos.c
30c30
< #include <catamount/cnos_mpi_os.h>
---
> //#include <catamount/cnos_mpi_os.h>
40a41,42
> #undef printf
> #define printf(arg,...)
123a126
> printf("%s %d\n",__FUNCTION__,__LINE__);
137a141
> printf("%s %d\n",__FUNCTION__,__LINE__);
143a148
> printf("%s %d\n",__FUNCTION__,__LINE__);
149a155
> printf("%s %d\n",__FUNCTION__,__LINE__);
155a162,163
> printf("%s %d\n",__FUNCTION__,__LINE__);
> 
160c168
<     cnos_pm_barrier(1);
---
> //    cnos_pm_barrier(1);
169a178
> printf("%s %d\n",__FUNCTION__,__LINE__);
176a186
> printf("%s %d\n",__FUNCTION__,__LINE__);
181a192
> printf("%s %d\n",__FUNCTION__,__LINE__);
187a199
> printf("%s %d\n",__FUNCTION__,__LINE__);
194a207
> printf("%s %d\n",__FUNCTION__,__LINE__);
201a215
> printf("%s %d\n",__FUNCTION__,__LINE__);
206a221
> printf("%s %d %s\n",__FUNCTION__,__LINE__, key);
213a229
> printf("%s %d %s\n",__FUNCTION__,__LINE__, key);
218a235
> printf("%s %d\n",__FUNCTION__,__LINE__);
223a241
> printf("%s %d\n",__FUNCTION__,__LINE__);
226d243
< 
diff -r openmpi-1.2.9/orte/mca/rmgr/cnos/rmgr_cnos_component.c openmpi-patch/orte/mca/rmgr/cnos/rmgr_cnos_component.c
20c20
< #include <catamount/cnos_mpi_os.h>
---
> //#include <catamount/cnos_mpi_os.h>
33a34,36
> #undef printf
> #define printf(arg,...)
> 
75a79
> printf("%s %d\n",__FUNCTION__,__LINE__);
84a89,90
> printf("%s %d\n",__FUNCTION__,__LINE__);
> 
89c95
<     cnos_pm_barrier(0);
---
> //    cnos_pm_barrier(0);
100a107
> printf("%s %d\n",__FUNCTION__,__LINE__);
diff -r openmpi-1.2.9/orte/mca/rml/cnos/rml_cnos.c openmpi-patch/orte/mca/rml/cnos/rml_cnos.c
24a25
> #include "lwkOrteRmlBinding.h"
28c29
< #include <catamount/cnos_mpi_os.h>
---
> //#include <catamount/cnos_mpi_os.h>
30a32,34
> #undef printf
> #define printf(arg,...)
> 
78a83
> static void* _boo;
82a88
>     _boo = lwkOrteRmlAlloc();
90a97
>     printf("%s %d\n",__FUNCTION__,__LINE__);
97a105
>     lwkOrteRmlFree( _boo );
103a112,113
>     printf("%s %d\n",__FUNCTION__,__LINE__);
>     lwkOrteRmlInit( _boo, orte_process_info.my_name );
109a120
>     printf("%s %d\n",__FUNCTION__,__LINE__);
115a127
>     printf("%s %d\n",__FUNCTION__,__LINE__);
121a134
> printf("%s %d\n",__FUNCTION__,__LINE__);
128a142
> printf("%s %d\n",__FUNCTION__,__LINE__);
134a149
> printf("%s %d\n",__FUNCTION__,__LINE__);
141a157
> printf("%s %d\n",__FUNCTION__,__LINE__);
149a166
> printf("%s %d\n",__FUNCTION__,__LINE__);
157a175
> printf("%s %d\n",__FUNCTION__,__LINE__);
164a183
> printf("%s %d\n",__FUNCTION__,__LINE__);
174a194
> printf("%s %d\n",__FUNCTION__,__LINE__);
186c206,208
<     return ORTE_SUCCESS;
---
> 
>     return lwkOrteRmlSendBufferNB( _boo, peer, buffer,
> 						tag, flags, cbfunc, cbdata );
196c218
<     return ORTE_SUCCESS;
---
>     return lwkOrteRmlRecvNB( _boo, peer, tag, flags, cbfunc, cbdata );
206c228
<     return ORTE_SUCCESS;
---
>     return lwkOrteRmlRecvBufferNB( _boo, peer, tag, flags, cbfunc, cbdata );
212c234
<     return ORTE_ERR_NOT_SUPPORTED;
---
>     return lwkOrteRmlRecvCancel( _boo, peer, tag );
218,222c240
< #if OMPI_RML_CNOS_HAVE_BARRIER
<     cnos_barrier();
< #endif
< 
<     return ORTE_SUCCESS;
---
>     return lwkOrteRmlBarrier( _boo );
232a251
> printf("%s %d\n",__FUNCTION__,__LINE__);
diff -r openmpi-1.2.9/orte/mca/sds/cnos/sds_cnos_module.c openmpi-patch/orte/mca/sds/cnos/sds_cnos_module.c
22c22
< #include <catamount/cnos_mpi_os.h>
---
> //#include <catamount/cnos_mpi_os.h>
27c27
< #include "orte/mca/sds/cnos/sds_cnos.h"
---
> //#include "orte/mca/sds/cnos/sds_cnos.h"
32,36c32,33
< orte_sds_base_module_t orte_sds_cnos_module = {
<     orte_sds_cnos_contact_universe,
<     orte_sds_cnos_set_name,
<     orte_sds_cnos_finalize,
< };
---
> #undef printf
> #define printf(arg,...)
38c35
< int
---
> static int
65c62,64
< int
---
> #include <stdio.h>
> 
> static int
72a72,93
> 	printf("%s():%d: \n",__FUNCTION__,__LINE__);
> 
>     FILE* fp;
> 
>     #define BUF_LEN 100
>     char buf[BUF_LEN];
>     snprintf(buf,BUF_LEN,"/proc/%d/app-info", getpid() );
>     if ( ( fp = fopen( buf, "r" ) ) == -1 ) {
> 	    printf("%s():%d:  fopen( %s) failed: %s \n",__FUNCTION__,__LINE__,
>                     buf,strerror(errno));
> 	    return ORTE_ERROR;
>     }
> 
>     int nRanks, myRank; 
>     if ( fscanf( fp, "%d\n%d\n", &nRanks, &myRank ) != 2 ) {
> 	printf("%s():%d:  fscanf app-info failed\n",__FUNCTION__,__LINE__);
> 	return ORTE_ERROR;
>     }
> 
>     fclose( fp );
> 
>     printf("%s %d nRanks=%d myRank=%d\n",__FUNCTION__,__LINE__,nRanks,myRank);
80c101
<     vpid = (orte_vpid_t) cnos_get_rank();
---
>     vpid = (orte_vpid_t) myRank;//cnos_get_rank();
90c111
<     orte_process_info.num_procs = (size_t) cnos_get_size();
---
>     orte_process_info.num_procs = (size_t) nRanks;//cnos_get_size();
96c117
< int 
---
> static int 
98a120
> 	printf("%s():%d: \n",__FUNCTION__,__LINE__);
100a123,130
> 
> 
> orte_sds_base_module_t orte_sds_cnos_module = {
>     orte_sds_cnos_contact_universe,
>     orte_sds_cnos_set_name,
>     orte_sds_cnos_finalize,
> };
> 
